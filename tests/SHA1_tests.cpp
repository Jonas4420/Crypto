#include <vector>

#include "gtest/gtest.h"
#include "gmock/gmock.h"

#include "crypto/Utils.hpp"
#include "crypto/SHA1.hpp"

TEST(SHA1, digest_test_vector)
{
	const std::vector<std::vector<std::string>> tests = {
		{
			"",
			"da39a3ee5e6b4b0d3255bfef95601890afd80709"
		}, {
			"a8",
			"99f2aa95e36f95c2acb0eaf23998f030638f3f15"
		}, {
			"3000",
			"f944dcd635f9801f7ac90a407fbc479964dec024"
		}, {
			"42749e",
			"a444319e9b6cc1e8464c511ec0969c37d6bb2619"
		}, {
			"9fc3fe08",
			"16a0ff84fcc156fd5d3ca3a744f20a232d172253"
		}, {
			"b5c1c6f1af",
			"fec9deebfcdedaf66dda525e1be43597a73a1f93"
		}, {
			"ec29561244ede706b6eb30a1c371d74450a105c3f9735f7fa9fe38cf67f304a5"
			"736a106e92e17139a6813b1c81a4f3d3fb9546ab4296fa9f722826c066869eda"
			"cd73b2548035185813e22634a9da44000d95a281ff9f264ecce0a931222162d0"
			"21cca28db5f3c2aa24945ab1e31cb413ae29810fd794cad5dfaf29ec43cb38d1"
			"98fe4ae1da2359780221405bd6712a5305da4b1b737fce7cd21c0eb7728d0823"
			"5a9011",
			"970111c4e77bcc88cc20459c02b69b4aa8f58217"
		}, {
			"5fc2c3f6a7e79dc94be526e5166a238899d54927ce470018fbfd668fd9dd97cb"
			"f64e2c91584d01da63be3cc9fdff8adfefc3ac728e1e335b9cdc87f069172e32"
			"3d094b47fa1e652afe4d6aa147a9f46fda33cacb65f3aa12234746b9007a8c85"
			"fe982afed7815221e43dba553d8fe8a022cdac1b99eeeea359e5a9d2e72e382d"
			"ffa6d19f359f4f27dc3434cd27daeeda8e38594873398678065fbb23665aba93"
			"09d946135da0e4a4afdadff14db18e85e71dd93c3bf9faf7f25c8194c4269b1e"
			"e3d9934097ab990025d9c3aaf63d5109f52335dd3959d38ae485050e4bbb6235"
			"574fc0102be8f7a306d6e8de6ba6becf80f37415b57f9898a5824e7741419742"
			"2be3d36a6080",
			"0423dc76a8791107d14e13f5265b343f24cc0f19"
		}, {
			"0f865f46a8f3aed2da18482aa09a8f390dc9da07d51d1bd10fe0bf5f3928d592"
			"7d08733d32075535a6d1c8ac1b2dc6ba0f2f633dc1af68e3f0fa3d85e6c60cb7"
			"b56c239dc1519a007ea536a07b518ecca02a6c31b46b76f021620ef3fc697680"
			"4018380e5ab9c558ebfc5cb1c9ed2d974722bf8ab6398f1f2b82fa5083f85c16"
			"a5767a3a07271d67743f00850ce8ec428c7f22f1cf01f99895c0c844845b06a0"
			"6cecb0c6cf83eb55a1d4ebc44c2c13f6f7aa5e0e08abfd84e7864279057abc47"
			"1ee4a45dbbb5774afa24e51791a0eada11093b88681fe30baa3b2e94113dc633"
			"42c51ca5d1a6096d0897b626e42cb91761058008f746f35465465540ad8c6b8b"
			"60f7e1461b3ce9e6529625984cb8c7d46f07f735be067588a0117f23e34ff578"
			"00e2bbe9a1605fde6087fb15d22c5d3ac47566b8c448b0cee40373e5ba6eaa21"
			"abee71366afbb27dbbd300477d70c371e7b8963812f5ed4fb784fb2f3bd1d3af"
			"e883cdd47ef32beaea",
			"6692a71d73e00f27df976bc56df4970650d90e45"
		}, {
			"8236153781bd2f1b81ffe0def1beb46f5a70191142926651503f1b3bb1016acd"
			"b9e7f7acced8dd168226f118ff664a01a8800116fd023587bfba52a255839347"
			"6f5fc69ce9c65001f23e70476d2cc81c97ea19caeb194e224339bcb23f77a83f"
			"eac5096f9b3090c51a6ee6d204b735aa71d7e996d380b80822e4dfd43683af9c"
			"7442498cacbea64842dfda238cb099927c6efae07fdf7b23a4e4456e0152b248"
			"53fe0d5de4179974b2b9d4a1cdbefcbc01d8d311b5dda059136176ea698ab82a"
			"cf20dd490be47130b1235cb48f8a6710473cfc923e222d94b582f9ae36d4ca2a"
			"32d141b8e8cc36638845fbc499bce17698c3fecae2572dbbd470552430d7ef30"
			"c238c2124478f1f780483839b4fb73d63a9460206824a5b6b65315b21e3c2f24"
			"c97ee7c0e78faad3df549c7ca8ef241876d9aafe9a309f6da352bec2caaa92ee"
			"8dca392899ba67dfed90aef33d41fc2494b765cb3e2422c8e595dabbfaca2177"
			"57453fb322a13203f425f6073a9903e2dc5818ee1da737afc345f0057744e3a5"
			"6e1681c949eb12273a3bfc20699e423b96e44bd1ff62e50a848a890809bfe161"
			"1c6787d3d741103308f849a790f9c015098286dbacfc34c1718b2c2b77e32194"
			"a75dda37954a320fa68764027852855a7e5b5274eb1e2cbcd27161d98b59ad24"
			"5822015f48af82a45c0ed59be94f9af03d9736048570d6e3ef63b1770bc98dfb"
			"77de84b1bb1708d872b625d9ab9b06c18e5dbbf34399391f0f8aa26ec0dac7ff"
			"4cb8ec97b52bcb942fa6db2385dcd1b3b9d567aaeb425d567b0ebe267235651a"
			"1ed9bf78fd93d3c1dd077fe340bb04b00529c58f45124b717c168d07e9826e33"
			"376988bc5cf62845c2009980a4dfa69fbc7e5a0b1bb20a5958ca967aec68eb31"
			"dd8fccca9afcd30a26bab26279f1bf6724ff",
			"11863b483809ef88413ca9b0084ac4a5390640af"
		}
	};

	for ( auto test : tests ) {
		uint8_t in[2048];
		std::size_t in_sz = sizeof(in);
		uint8_t out[Crypto::SHA1::SIZE];
		std::string output;

		Crypto::Utils::from_hex(test[0], in, in_sz);
		Crypto::MessageDigest_get<Crypto::SHA1>(in, in_sz, out);
		Crypto::Utils::to_hex(out, sizeof(out), output, false);

		EXPECT_THAT(output, test[1]);
	}
}

TEST(SHA1, reset_ctx)
{
	const std::vector<std::vector<std::string>> tests = {
		{
			"",
			"da39a3ee5e6b4b0d3255bfef95601890afd80709"
		}, {
			"a8",
			"99f2aa95e36f95c2acb0eaf23998f030638f3f15"
		}, {
			"3000",
			"f944dcd635f9801f7ac90a407fbc479964dec024"
		}, {
			"42749e",
			"a444319e9b6cc1e8464c511ec0969c37d6bb2619"
		}, {
			"9fc3fe08",
			"16a0ff84fcc156fd5d3ca3a744f20a232d172253"
		}, {
			"b5c1c6f1af",
			"fec9deebfcdedaf66dda525e1be43597a73a1f93"
		}, {
			"ec29561244ede706b6eb30a1c371d74450a105c3f9735f7fa9fe38cf67f304a5"
			"736a106e92e17139a6813b1c81a4f3d3fb9546ab4296fa9f722826c066869eda"
			"cd73b2548035185813e22634a9da44000d95a281ff9f264ecce0a931222162d0"
			"21cca28db5f3c2aa24945ab1e31cb413ae29810fd794cad5dfaf29ec43cb38d1"
			"98fe4ae1da2359780221405bd6712a5305da4b1b737fce7cd21c0eb7728d0823"
			"5a9011",
			"970111c4e77bcc88cc20459c02b69b4aa8f58217"
		}, {
			"5fc2c3f6a7e79dc94be526e5166a238899d54927ce470018fbfd668fd9dd97cb"
			"f64e2c91584d01da63be3cc9fdff8adfefc3ac728e1e335b9cdc87f069172e32"
			"3d094b47fa1e652afe4d6aa147a9f46fda33cacb65f3aa12234746b9007a8c85"
			"fe982afed7815221e43dba553d8fe8a022cdac1b99eeeea359e5a9d2e72e382d"
			"ffa6d19f359f4f27dc3434cd27daeeda8e38594873398678065fbb23665aba93"
			"09d946135da0e4a4afdadff14db18e85e71dd93c3bf9faf7f25c8194c4269b1e"
			"e3d9934097ab990025d9c3aaf63d5109f52335dd3959d38ae485050e4bbb6235"
			"574fc0102be8f7a306d6e8de6ba6becf80f37415b57f9898a5824e7741419742"
			"2be3d36a6080",
			"0423dc76a8791107d14e13f5265b343f24cc0f19"
		}, {
			"0f865f46a8f3aed2da18482aa09a8f390dc9da07d51d1bd10fe0bf5f3928d592"
			"7d08733d32075535a6d1c8ac1b2dc6ba0f2f633dc1af68e3f0fa3d85e6c60cb7"
			"b56c239dc1519a007ea536a07b518ecca02a6c31b46b76f021620ef3fc697680"
			"4018380e5ab9c558ebfc5cb1c9ed2d974722bf8ab6398f1f2b82fa5083f85c16"
			"a5767a3a07271d67743f00850ce8ec428c7f22f1cf01f99895c0c844845b06a0"
			"6cecb0c6cf83eb55a1d4ebc44c2c13f6f7aa5e0e08abfd84e7864279057abc47"
			"1ee4a45dbbb5774afa24e51791a0eada11093b88681fe30baa3b2e94113dc633"
			"42c51ca5d1a6096d0897b626e42cb91761058008f746f35465465540ad8c6b8b"
			"60f7e1461b3ce9e6529625984cb8c7d46f07f735be067588a0117f23e34ff578"
			"00e2bbe9a1605fde6087fb15d22c5d3ac47566b8c448b0cee40373e5ba6eaa21"
			"abee71366afbb27dbbd300477d70c371e7b8963812f5ed4fb784fb2f3bd1d3af"
			"e883cdd47ef32beaea",
			"6692a71d73e00f27df976bc56df4970650d90e45"
		}, {
			"8236153781bd2f1b81ffe0def1beb46f5a70191142926651503f1b3bb1016acd"
			"b9e7f7acced8dd168226f118ff664a01a8800116fd023587bfba52a255839347"
			"6f5fc69ce9c65001f23e70476d2cc81c97ea19caeb194e224339bcb23f77a83f"
			"eac5096f9b3090c51a6ee6d204b735aa71d7e996d380b80822e4dfd43683af9c"
			"7442498cacbea64842dfda238cb099927c6efae07fdf7b23a4e4456e0152b248"
			"53fe0d5de4179974b2b9d4a1cdbefcbc01d8d311b5dda059136176ea698ab82a"
			"cf20dd490be47130b1235cb48f8a6710473cfc923e222d94b582f9ae36d4ca2a"
			"32d141b8e8cc36638845fbc499bce17698c3fecae2572dbbd470552430d7ef30"
			"c238c2124478f1f780483839b4fb73d63a9460206824a5b6b65315b21e3c2f24"
			"c97ee7c0e78faad3df549c7ca8ef241876d9aafe9a309f6da352bec2caaa92ee"
			"8dca392899ba67dfed90aef33d41fc2494b765cb3e2422c8e595dabbfaca2177"
			"57453fb322a13203f425f6073a9903e2dc5818ee1da737afc345f0057744e3a5"
			"6e1681c949eb12273a3bfc20699e423b96e44bd1ff62e50a848a890809bfe161"
			"1c6787d3d741103308f849a790f9c015098286dbacfc34c1718b2c2b77e32194"
			"a75dda37954a320fa68764027852855a7e5b5274eb1e2cbcd27161d98b59ad24"
			"5822015f48af82a45c0ed59be94f9af03d9736048570d6e3ef63b1770bc98dfb"
			"77de84b1bb1708d872b625d9ab9b06c18e5dbbf34399391f0f8aa26ec0dac7ff"
			"4cb8ec97b52bcb942fa6db2385dcd1b3b9d567aaeb425d567b0ebe267235651a"
			"1ed9bf78fd93d3c1dd077fe340bb04b00529c58f45124b717c168d07e9826e33"
			"376988bc5cf62845c2009980a4dfa69fbc7e5a0b1bb20a5958ca967aec68eb31"
			"dd8fccca9afcd30a26bab26279f1bf6724ff",
			"11863b483809ef88413ca9b0084ac4a5390640af"
		}
	};

	for ( auto test : tests ) {
		uint8_t in[2048];
		std::size_t in_sz = sizeof(in);

		uint8_t out_1[Crypto::SHA1::SIZE];
		uint8_t out_2[Crypto::SHA1::SIZE];
		std::string output_1 = "", output_2 = "";

		Crypto::Utils::from_hex(test[0], in, in_sz);

		Crypto::SHA1 ctx;
		ctx.update(in, in_sz);
		ctx.reset();
		ctx.update(in, in_sz);
		ctx.finish(out_1);
		Crypto::Utils::to_hex(out_1, sizeof(out_1), output_1, false);

		ctx.update(in, in_sz);
		ctx.finish(out_2);
		Crypto::Utils::to_hex(out_2, sizeof(out_2), output_2, false);

		EXPECT_THAT(output_1, test[1]);
		EXPECT_THAT(output_2, test[1]);
	}
}
